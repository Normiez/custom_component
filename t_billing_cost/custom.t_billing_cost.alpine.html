<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.5/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
  ></script>
  <style>
    [x-cloak] {
      display: none;
    }

    td {
      padding-top: 15px;
      padding-bottom: 15px;
      padding-right: 15px;
      min-width: 120px;
    }
    th {
      padding-top: 15px;
      padding-bottom: 15px;
      padding-right: 15px;
    }
  </style>
  <script>
    function main() {
      return {
        //URL
        mainUrl: "",
        token: "",

        // State
        checkedAll: true,
        headerData: {},
        detailData: [],
        insertHeaderData: {},
        insertDetailData: [],
        detailDataIds: [],

        async initialization() {
          try {
            this.checkedAll = true;
            this.mainUrl = "https://dev-psistudio.soedarpo.id:63222"; // minta Anwar untuk link yang benernya
            this.token =
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluX2lzdGEiLCJhcHBzX2lkIjo3NCwiZW52IjoiZGV2IiwidXNlcl9pZCI6MTI4ODI3MCwiaXNfaW5kZXBlbmRlbnRfdXNlciI6MCwiZnVsbF9uYW1lIjoiQWRtaW4gSXN0YSIsImVtYWlsIjoiYWRtaW5faXN0YUBnbWFpbC5jb20iLCJtX2VtcGxveWVlX2lkIjoxMCwiY29tcGFueV9pZCI6MTAsImNvbXBhbnlfY29kZSI6IklTVEEiLCJjb21wYW55X3Bvc2l0aW9uX2lkIjoxLCJjb21wYW55X3Bvc2l0aW9uX2NvZGUiOiJCSVNUQSIsImNvbXBhbnlfcG9zaXRpb25fbmFtZSI6IkJhciBJU1RBIiwiYnJhbmNoX2lkIjoxLCJicmFuY2hfY29kZSI6IlBTVCIsImtleVRva2VuIjoiNmM0ZTcxNWUtMzlhNC00M2YyLTg0MWQtZjFiMDIyMjY3NGJiIiwiaWF0IjoxNzA1Mjg4Njc2LCJleHAiOjE3MDUyOTIyNzZ9.A_itI5z8qGwt_8lQnboo0bfU8uqat6xXTvD1kDZIThI";
            const idData = document.querySelector("#id");
            const jobOrderCode = document.querySelector("#code");
            const jobOrderDate = document.querySelector("#job_order_date");
            const vendorName = document.querySelector("#vendor_name");
            const salesName = document.querySelector("#sales_name");
            const serviceName = document.querySelector("#service_name");
            const serviceDetailName = document.querySelector(
              "#service_detail_name"
            );
            const projectName = document.querySelector("#project_name");
            const reffNo = document.querySelector("#reff_no");
            const referenceUrl = document.querySelector("#reference_url");
            const remarks = document.querySelector("#remarks");
            const m_vendor_id = document.querySelector("#m_vendor_id");
            const employee_id = document.querySelector("#employee_id");
            const m_project_id = document.querySelector("#m_project_id");
            const m_service_id = document.querySelector("#m_service_id");
            const m_service_detail_id = document.querySelector(
              "#m_service_detail_id"
            );

            // URL
            // document.getElementById("cancel-button-child").style.display = "none";

            this.headerData = {
              jobOrderId: idData != null ? idData : "",
              jobOrderCode: jobOrderCode != null ? jobOrderCode.value : "",
              jobOrderDate: jobOrderDate != null ? jobOrderDate.value : "",
              vendor_name: vendorName != null ? vendorName.value : "",
              sales_name: salesName != null ? salesName.value : "",
              service_name: serviceName != null ? serviceName.value : "",
              service_detail_name:
                serviceDetailName != null ? serviceDetailName.value : "",
              project_name: projectName != null ? projectName.value : "",
              reff_no: reffNo != null ? reffNo.value : "",
              remarks: remarks != null ? remarks.value : "",
              referenceUrl: referenceUrl != null ? referenceUrl.value : "",
              m_vendor_id: m_vendor_id != null ? m_vendor_id.value : "",
              employee_id: employee_id != null ? employee_id.value : "",
              m_project_id: m_project_id != null ? m_project_id.value : "",
              m_service_id: m_service_id != null ? m_service_id.value : "",
              m_service_detail_id:
                m_service_detail_id != null ? m_service_detail_id.value : "",
            };
            this.detailData = [
              {
                id: 54,
                linenum: 1,
                activity_flag: "Cost",
                charge_name: "Rental Code 1",
                charge_type: "RI",
                bill_type: "AP",
                vendor_name: "Djava Vista",
                remarks: "Coba di tes aja",
                currency_code: "IDR",
                uom_name: "Kilogram",
                general_arrangement: "Yes",
                frequency: "1",
                price: "250000",
                quantity: 20,
                vat_tax_name: "PPN 1%",
                wht_tax_name: "PPH 20%",
                total_amount: 5000000,
              },
              {
                id: 73,
                linenum: 2,
                activity_flag: "Cost",
                charge_name: "Rental Code 1",
                charge_type: "RI",
                bill_type: "AP",
                vendor_name: "Djava Vista",
                remarks: "Coba di tes aja",
                currency_code: "IDR",
                uom_name: "Kilogram",
                general_arrangement: "Yes",
                frequency: "1",
                price: "250000",
                quantity: 20,
                vat_tax_name: "PPN 10%",
                wht_tax_name: "PPH 5%",
                total_amount: 5000000,
              },
              {
                id: 77,
                linenum: 3,
                activity_flag: "Cost",
                charge_name: "Rental Code 1",
                charge_type: "RI",
                bill_type: "AP",
                vendor_name: "Djava Vista",
                remarks: "Coba di tes aja",
                currency_code: "IDR",
                uom_name: "Kilogram",
                general_arrangement: "Yes",
                frequency: "1",
                price: "250000",
                quantity: 20,
                vat_tax_name: "PPN 10%",
                wht_tax_name: "PPH 20% (EXCLUDE)",
                total_amount: 5000000,
              },
              {
                id: 79,
                linenum: 4,
                activity_flag: "Cost",
                charge_name: "Rental Code 1",
                charge_type: "RI",
                bill_type: "AP",
                vendor_name: "Djava Vista",
                remarks: "Coba di tes aja",
                currency_code: "IDR",
                uom_name: "Kilogram",
                general_arrangement: "Yes",
                frequency: "1",
                price: "250000",
                quantity: 20,
                vat_tax_name: "PPN 20% (INCLUDE)",
                wht_tax_name: "PPH 20% (EXCLUDE)",
                total_amount: 5000000,
              },
            ];
            //kalo mau groupby
            const vat_obj = Object.groupBy(
              this.detailData,
              ({ vat_tax_name }) => vat_tax_name
            );
            for (const key in vat_obj) {
              console.log(vat_obj[key]);
              const data = vat_obj[key];
              let sum = 0;
              let totalPrice = data.reduce(
                (accumulator, currentValue) => accumulator + currentValue,
                sum
              );
              console.log(totalPrice)
            }
            this.insertDetailData = JSON.parse(JSON.stringify(this.detailData));
          } catch (err) {
            console.log(err);
          }
        },

        async submitToDatabase() {
          try {
            let detailPayload = [];
            for (let i = 0; i < this.insertDetailData.length; i++) {
              const el = this.insertDetailData[i];
              el !== null ? detailPayload.push(el) : null;
            }
            console.log(detailPayload);
          } catch (err) {
            console.log(err);
          }
        },

        async insertIntoBillingCost() {
          try {
          } catch (error) {}
        },

        checkboxChecking() {
          let checkboxes = document.getElementsByName("checklist");
          let flag = true;
          for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked == false ? (flag = false) : null;
          }
          this.checkedAll = flag;
        },
        init() {
          this.initialization();
        },
      };
    }
  </script>
  <div x-data="main()">
    <div class="flex flex-rows mx-5">
      <h1 class="mr-2 text-xs font-light">FINANCIAL</h1>
      <h1 class="mr-2 text-xs font-extrabold">></h1>
      <h1 class="mr-2 text-xs font-light">WORK ORDER BILLING COST</h1>
      <h1 class="mr-2 text-xs font-extrabold">></h1>
      <h1 class="mr-2 text-xs font-light">CREATE WORK ORDER BILLING COST</h1>
    </div>
    <form>
      <div class="grid grid-cols-2">
        <div class="grid grid-rows-2 h-fit">
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Job Order Code</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              type="text"
              x-model="headerData.jobOrderCode"
              disabled
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Job Order Date</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              type="text"
              x-model="headerData.jobOrderDate"
              disabled
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Vendor</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              x-model="headerData.vendor_name"
              disabled
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Sales Name</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              x-model="headerData.sales_name"
              disabled
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Reference Document</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              type="file"
              disabled
            />
          </div>
        </div>
        <div class="grid grid-rows-2 h-fit">
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Service Name</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              type="text"
              x-model="headerData.service_name"
              disabled
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Service Detail Name</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              type="text"
              x-model="headerData.service_detail_name"
              disabled
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Project Name</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base bg-gray-200"
              x-model="headerData.project_name"
              disabled
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Reference No</label>
            <input
              class="w-full border-2 rounded-xl py-1 px-3 text-base"
              x-model="headerData.reff_no"
            />
          </div>
          <div class="flex flex-col text-sm my-2 px-5">
            <label class="py-2">Remarks</label>
            <textarea
              class="w-full border-2 rounded-xl py-1 px-3 text-base"
              rows="3"
              x-text="headerData.remarks"
            ></textarea>
          </div>
        </div>
      </div>
    </form>
    <!-- checkbox -->
    <div class="mx-5 mt-5 px-2 py-3 border-2">
      <h1 class="text-lg font-semibold py-2 mb-4 border-b-2">
        Billing Details
      </h1>
      <div class="overflow-x-scroll overflow-scroll pb-5">
        <table class="table-auto w-full text-center">
          <thead>
            <tr class="bg-gray-200 text-base">
              <th>
                <input
                  x-model="checkedAll"
                  @change="()=>{
                    if(checkedAll){
                      let checkboxes = document.getElementsByName('checklist');
                      for (let i = 0; i < checkboxes.length; i++) {
                        checkboxes[i].checked = true
                      }

                    }else {
                      let checkboxes = document.getElementsByName('checklist');
                      for (let i = 0; i < checkboxes.length; i++) {
                        checkboxes[i].checked = false
                        insertDetailData[i] = null
                      }
                    }
                    
                  }"
                  type="checkbox"
                  class="ml-5 w-5 h-5"
                />
              </th>
              <th>Lineum</th>
              <th>Activity Flag</th>
              <th>Charge</th>
              <th>Charge Type</th>
              <th>Bill Type</th>
              <th>Vendor</th>
              <th>Remarks</th>
              <th>Currency</th>
              <th>UOM</th>
              <th>General Arrangement</th>
              <th>Frequency</th>
              <th>Price</th>
              <th>Qty</th>
              <th>VAT Tax</th>
              <th>WHT Tax</th>
              <!-- <th>Tax Type</th> -->
              <th>Total Amount</th>
              <th>DK</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(data, index) in detailData" :key="index">
              <tr class="hover:bg-gray-100">
                <td x-data="isChecked = true">
                  <input
                    type="checkbox"
                    name="checklist"
                    x-model="isChecked"
                    @change="()=>{
                    if(isChecked){
                      insertDetailData[index] = data
                      checkboxChecking()
                    }else {
                      insertDetailData[index] = null
                      checkedAll = false
                     }
                    
                  }"
                    class="ml-5 w-5 h-5"
                  />
                </td>
                <td x-text="data.linenum"></td>
                <td x-text="data.activity_flag"></td>
                <td x-text="data.charge_name"></td>
                <td x-text="data.charge_type"></td>
                <td x-text="data.bill_type"></td>
                <td x-text="data.vendor_name"></td>
                <td>
                  <input
                    type="text"
                    x-model="data.remarks"
                    class="w-full border-2 rounded-lg p-2 text-base"
                    @keyup="()=>{
                      if(isChecked == true){
                        insertDetailData[index].remarks = data.remarks
                      }
                  }"
                  />
                </td>
                <td x-text="data.currency_code"></td>
                <td x-text="data.uom_name"></td>
                <td x-text="data.general_arrangement"></td>
                <td x-text="data.frequency"></td>
                <td>
                  <input
                    type="number"
                    :value="data.price"
                    x-model="data.price"
                    @keyup="()=>{
                      if(isChecked == true){
                        insertDetailData[index].price = data.price
                        data.total_amount = data.price * data.quantity * data.frequency
                        insertDetailData[index].total_amount = data.total_amount
                      }
                }"
                    class="w-full border-2 rounded-lg p-2 text-base"
                  />
                </td>
                <td x-text="data.quantity"></td>
                <td x-text="data.vat_tax_name"></td>
                <td x-text="data.wht_tax_name"></td>
                <!-- <td>6198</td> -->
                <td x-text="data.total_amount"></td>
                <td>D</td>
              </tr>
            </template>
            <tr class="hover:bg-gray-100">
              <td>
                <input type="checkbox" class="ml-5 w-5 h-5" />
              </td>
              <td>1</td>
              <td>Cost</td>
              <td>Rental Code</td>
              <td>RI</td>
              <td>AP</td>
              <td>Djava Vista</td>
              <td>
                <input
                  type="text"
                  class="w-full border-2 rounded-lg p-2 text-base"
                />
              </td>
              <td>IDR</td>
              <td>Kilogram</td>
              <td>Yes</td>
              <td>1</td>
              <td>
                <input
                  type="number"
                  class="w-full border-2 rounded-lg p-2 text-base"
                />
              </td>
              <td>2</td>
              <td>PPN 10%</td>
              <td>PPH 20%</td>
              <!-- <td>6198</td> -->
              <td>10000000</td>
              <td>D</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="flex flex-rows p-5">
      <button
        class="px-3 py-2 bg-blue-400 rounded-xl hover:bg-blue-600 text-white"
        @click="submitToDatabase()"
      >
        Save
      </button>
    </div>
  </div>
</body>
